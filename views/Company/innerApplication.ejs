<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Application Details</title>
</head>
<body>
    <header>
        <% include('../partials/nav') %>
    </header>
    <div class="container mt-3">
        <div class="row">
            <div class="col-md-12">
                <h1 class="h3 mb-3">Application Details</h1>
                <div class="card text-bg-dark bordered border-3 mb-3">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card-body">
                                <h3 class="card-title">Student Name: <%= application.Student.username %></h3>
                                <h5 class="card-title">Announcement Name: <%= application.Announcement.announcementName %></h5>
                                <!-- Include buttons for actions -->
                                <form id="ApplicationForm" enctype="multipart/form-data">
                                    <input type="text" name="internStartDate" placeholder="Intern start date" required>
                                    <input type="text" name="internEndDate" placeholder="Intern end date" required>
                                    <input type="text" name="internDuration" placeholder="Intern duration (work days)" required>
                                    <input type="text" name="dutyAndTitle" placeholder="Duty and title of the representative" required>
                                    <button type="submit">Confirm the information you entered.</button>
                                </form>
                                <button onclick="downloadButton('<%= application.id %>', 'CV')" class="btn btn-primary">Download CV</button>
                                <button onclick="downloadButton('<%= application.id %>', 'Application Form')" class="btn btn-primary">Download Application Form</button>
                                <button class="btn btn-success" onclick="updateApplication('<%= application.id %>', true)">Approve</button>
                                <button class="btn btn-danger" onclick="updateApplication('<%= application.id %>', false)">Reject</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById("ApplicationForm").addEventListener("submit", async function(event) {
            event.preventDefault(); // Prevent default form submission

            const formData = new FormData(this);

            try {
                const response = await fetch(`/company/applications/<%= application.id %>/fillApplicationForm`, {
                    method: "POST",
                    body: formData
                });

                if (!response.ok) {
                    throw new Error("Failed to submit form data.");
                }

                const data = await response.json();
                console.log("Form data successfully submitted", data);
                // You can add additional logic here if needed
            } catch (error) {
                console.error("Error:", error);
                alert("Failed to submit form data. Please try again.");
            }
        });

        async function downloadButton(applicationId, fileType) {
            try {
                const response = await fetch(`/company/announcements/download/${applicationId}/${fileType}`);
                if (!response.ok) {
                    throw new Error('Failed to download file');
                }

                const blob = await response.blob();
                const contentDispositionHeader = response.headers.get('Content-Disposition');
                const filename = contentDispositionHeader.split('filename=')[1].replace(/"/g, '');
                const url = window.URL.createObjectURL(blob);

                const link = document.createElement('a');
                link.href = url;
                link.setAttribute('download', filename);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error('Error downloading file:', error);
            }
        }

        async function updateApplication(applicationId, isApproved) {
            try {
                const response = await fetch(`/company/applications/${applicationId}`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ isApproved })
                });

                const data = await response.json();
                alert(data.message);
                location.reload(); // Reload the page to refresh the content
            } catch (error) {
                console.error("Error processing the request:", error);
                alert("An error occurred. Please try again later.");
            }
        }
    </script>
</body>
</html>